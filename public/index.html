<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Остатки Einhell</title>
  <meta name="description" content="Просмотр остатков Einhell" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --brand:#E2001A; --ink:#111111; --bg:#ffffff; --card:#f8f9fb;
      --muted:#6b7280; --accent:#111111;
      --orange:#F97316; --yellow:#FACC15; --green:#22C55E; --red:#E2001A;
      --radius:14px;
    }
    html[data-theme="dark"]{
      --bg:#1c1c1e; --card:#2c2c2e; --ink:#f2f2f7; --accent:#f2f2f7;
      --muted:#a1a1a6;
      --orange:#EA580C; --yellow:#C48B04; --green:#16A34A; --red:#F87171;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}

    /* HEADER */
    header{
      position:sticky;top:0;z-index:10;background:var(--brand);color:#fff;
      padding:10px 14px;box-shadow:0 2px 6px rgba(0,0,0,.15);
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .logo{height:28px;width:auto;display:block;background:#fff;padding:4px;border-radius:6px}
    .titles{display:flex;flex-direction:column;gap:2px}
    .title{font-weight:800;font-size:18px;letter-spacing:.2px}
    .sub{font-size:12px;opacity:.95}
    .hdr-btn{border:none;background:none;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:6px;border-radius:8px}
    .hdr-btn:hover{background:rgba(255,255,255,0.15)}
    #themeIcon{width:22px;height:22px}

    /* CONTROLS */
    .controls{padding:10px 12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:var(--bg);border-bottom:1px solid #eee}
    .search{flex:1 1 260px;position:relative}
    .search input{width:100%;padding:12px 40px 12px 12px;font-size:16px;border:1px solid #e5e7eb;border-radius:10px;outline:none;background:var(--bg);color:var(--ink)}
    .clear-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);border:none;background:transparent;font-size:18px;cursor:pointer;color:#9ca3af;padding:6px}
    .toggle{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted)}
    .sort{display:flex;align-items:center;gap:6px}
    select{padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:var(--bg);color:var(--ink)}
    .btn{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:var(--bg);cursor:pointer;color:var(--ink)}
    .btn:active{transform:scale(0.99)}

    /* LIST */
    .stats{padding:6px 14px;font-size:13px;color:var(--muted)}
    .list{padding:8px 10px 18px;display:grid;gap:10px}
    .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .card.oos{opacity:.45;filter:grayscale(100%)}
    .row1{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .sku{font-weight:800;font-size:15px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;font-weight:700;color:#fff;white-space:nowrap;display:inline-flex;align-items:center;gap:6px}
    .badge-dot{display:inline-block;width:8px;height:8px;border-radius:999px;background:currentColor}
    .model{margin:6px 0 6px;font-size:14px}
    .micro{font-size:12px;color:#2563eb;display:flex;gap:10px;flex-wrap:wrap}
    .micro a{color:#2563eb;text-decoration:none}
    .micro a:hover{text-decoration:underline}
    .meta{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .leftMeta{display:flex;align-items:center;gap:12px}
    .thumb{width:70px;height:70px;object-fit:contain;background:#fff;border-radius:10px;border:1px solid #eee;cursor:pointer}
    .thumb[hidden]{display:none}
    .price{color:var(--accent);font-weight:800}
    .b-red{background:var(--red)}
    .b-orange{background:var(--orange)}
    .b-yellow{background:var(--yellow);color:#111}
    .b-green{background:var(--green)}
    @media(min-width:760px){.list{grid-template-columns:repeat(2,1fr)} .card{padding:14px}}
    @media(min-width:1100px){.list{grid-template-columns:repeat(3,1fr)}}

    .footer{padding:20px 14px;text-align:center;color:var(--muted);font-size:12px}
    .error{color:var(--red);padding:12px 14px}

    /* DETAIL VIEW */
    .detail{padding:12px}
    .detail .topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .back{border:none;background:var(--bg);border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;cursor:pointer;color:var(--ink)}
    .detail .head{background:var(--card);border-radius:var(--radius);padding:12px;display:grid;gap:10px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .detail .head.oos{opacity:.65;filter:grayscale(100%)}
    .detail .hrow{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .detail .title1{font-weight:800}
    .detail .hero{display:flex;gap:14px;align-items:center}
    .detail .hero img{width:120px;height:120px;object-fit:contain;background:#fff;border-radius:10px;border:1px solid #eee;cursor:pointer}
    .tabs{margin-top:12px;display:flex;gap:6px;flex-wrap:wrap}
    .tabbtn{padding:8px 10px;border:1px solid #e5e7eb;border-radius:999px;background:var(--bg);cursor:pointer;font-size:13px;color:var(--ink)}
    .tabbtn.active{background:#111;color:#fff;border-color:#111}
    .tabpanel{margin-top:10px;background:var(--bg);border:1px solid #e5e7eb;border-radius:12px;padding:12px;color:var(--ink)}
    .block{background:#f9fafb;border:1px solid #eee;border-radius:8px;padding:10px}
    html[data-theme="dark"] .block{background:#2c2c2e;border-color:#3a3a3c}
    .block pre{white-space:pre-wrap;margin:0;font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .bullets{display:grid;grid-template-columns:1fr 1fr;gap:6px 18px;list-style:disc;padding-left:18px;margin:0;font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .bullets li{margin:0;line-height:1.35}
    @media(max-width:720px){ .bullets{grid-template-columns:1fr} }

    /* Lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:50}
    .lightbox img{max-width:92vw;max-height:90vh;background:#fff;border-radius:10px;padding:6px}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px">
      <img class="logo" src="../logo.png" alt="Einhell" onerror="this.style.display='none'">
      <div class="titles">
        <div class="title">Остатки Einhell</div>
        <div class="sub">Поиск по артикулу или модели</div>
      </div>
    </div>
    <button id="themeToggle" class="hdr-btn" title="Тема"><img id="themeIcon" alt="theme"></button>
  </header>

  <!-- LIST VIEW -->
  <div id="view-list">
    <div class="controls">
      <div class="search">
        <input id="q" type="text" placeholder="Ввести Артикул или Модель…" autocomplete="off" />
        <button class="clear-btn" id="clear" title="Очистить">✕</button>
      </div>
      <label class="toggle"><input type="checkbox" id="onlyInStock" /> Только в наличии</label>
      <label class="toggle"><input type="checkbox" id="showImages" /> Вкл. изображения</label>
      <div class="sort">
        <select id="sortKey">
          <option value="default">Сортировка: по умолчанию</option>
          <option value="price_desc">Цена ↓</option>
          <option value="price_asc">Цена ↑</option>
          <option value="stock_desc">Остаток ↓</option>
          <option value="stock_asc">Остаток ↑</option>
        </select>
      </div>
      <div class="sort">
        <select id="downloadFmt">
          <option value="xlsx">Excel (.xlsx)</option>
          <option value="csv">CSV (.csv)</option>
          <option value="json">JSON (.json)</option>
          <option value="xml">XML (.xml)</option>
        </select>
        <button class="btn" id="btnDownload">Скачать</button>
      </div>
    </div>
    <div class="stats" id="stats">Загрузка…</div>
    <div class="error" id="error" hidden></div>
    <div class="list" id="list"></div>
  </div>

  <!-- DETAIL VIEW -->
  <div id="view-detail" class="detail" hidden>
    <div class="topbar">
      <button class="back" id="btnBack">← Назад</button>
    </div>
    <div id="detail-head" class="head"></div>
    <div class="tabs" id="tabs"></div>
    <div class="tabpanel" id="tabpanel"></div>
  </div>

  <div class="footer" id="footer"></div>
  <div class="lightbox" id="lightbox" onclick="this.style.display='none'">
    <img id="lightboxImg" alt="preview">
  </div>
    <script>
    // ==== THEME TOGGLE ====
    const BULB_ON="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iMS41IiB2aWV3Qm94PSIwIDAgMjQgMjQiPjxwYXRoIGQ9Ik0xMiAydjIiLz48cGF0aCBkPSJNMTIgMjB2MiIvPjxwYXRoIGQ9Ik00LjIxIDQuMjFsMS40MSAxLjQxIi8+PHBhdGggZD0iTTguMjEgMTUuNzlsLTEuNDEgMS40MSIvPjxwYXRoIGQ9Ik0yIDEyaDIiLz48cGF0aCBkPSJNIDIwIDEyaDIiLz48cGF0aCBkPSJNNS42MyAxOC4zNyAxNC4zNyA1LjYzYTIgMiAwIDAgMC0yLjgzIDIuODN6Ii8+PC9zdmc+";
    const BULB_OFF="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iMS41IiB2aWV3Qm94PSIwIDAgMjQgMjQiPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjQiLz48cGF0aCBkPSJNMTIgMnYyIi8+PHBhdGggZD0iTTEyIDIwdjIiLz48cGF0aCBkPSJNNC4yMSA0LjIxbDEuNDEgMS40MSIvPjxwYXRoIGQ9Ik04LjIxIDE1Ljc5bC0xLjQxIDEuNDEiLz48cGF0aCBkPSJNMiAxMmgxIi8+PHBhdGggZD0iTTIxIDEyaDEiLz48cGF0aCBkPSJNNS42MyAxOC4zN0wxOC4zNyA1LjYzIi8+PC9zdmc+";

    const themeToggle=document.getElementById("themeToggle");
    const themeIcon=document.getElementById("themeIcon");
    function setBulb(){
      const cur=document.documentElement.getAttribute('data-theme')||'light';
      themeIcon.src=cur==='light'?BULB_ON:BULB_OFF;
    }
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme',t);
      localStorage.setItem('theme',t);
      setBulb();
    }
    themeToggle.addEventListener("click",()=>{
      const cur=document.documentElement.getAttribute('data-theme')||'light';
      applyTheme(cur==='light'?'dark':'light');
    });
    applyTheme(localStorage.getItem('theme')||'light');

    // ==== ORIGINAL PUBLIC JS ====

    // Data sources
    const XML_URL        = "https://einhellcentralasia.github.io/kaspi_stock/price.xml";
    const IMAGES_CSV_URL = "../images.csv";     // sku,url
    const DETAILS_CSV_URL= "../add_data.csv";   // sku,tech,log,marketing,add

    // Helpers
    function formatTenge(n){ if (isNaN(n)) return n; return new Intl.NumberFormat("ru-KZ",{maximumFractionDigits:0}).format(Number(n)) + " ₸"; }
    function debounce(fn,ms=220){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
    function getByLocalName(node, local){ return Array.from(node.getElementsByTagNameNS("*", local)); }
    function firstByLocalName(node, local){ const a=getByLocalName(node, local); return a.length?a[0]:null; }
    function escCSV(v){ const s=String(v??""); return /[",;\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
    function downloadBlob(filename, mime, data){ const blob=new Blob([data],{type:mime}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove(); }

    // DOM
    const viewList = document.getElementById("view-list");
    const viewDetail = document.getElementById("view-detail");
    const q=document.getElementById("q");
    const clearBtn=document.getElementById("clear");
    const onlyInStock=document.getElementById("onlyInStock");
    const showImages=document.getElementById("showImages");
    const sortKey=document.getElementById("sortKey");
    const downloadFmt=document.getElementById("downloadFmt");
    const btnDownload=document.getElementById("btnDownload");
    const list=document.getElementById("list");
    const stats=document.getElementById("stats");
    const errorBox=document.getElementById("error");
    const footer=document.getElementById("footer");
    const lightbox=document.getElementById("lightbox");
    const lightboxImg=document.getElementById("lightboxImg");
    const btnBack=document.getElementById("btnBack");
    const detailHead=document.getElementById("detail-head");
    const tabsEl=document.getElementById("tabs");
    const tabpanel=document.getElementById("tabpanel");

    // Data
    let OFFERS=[];             // {sku, model, modelLC, stock, price}
    let IMG_MAP=new Map();     // sku -> url
    let DETAIL_MAP=new Map();  // sku -> {tech,log,marketing,add}

    // Traffic light mapping
    function stockBucket(stock){
      if (stock <= 0)  return { label:"Нет в наличии", cls:"b-red" };
      if (stock < 10)  return { label:"Менее 10", cls:"b-orange" };
      if (stock < 50)  return { label:"Менее 50", cls:"b-yellow" };
      return { label:"Более 50", cls:"b-green" };
    }

    // Fetchers
    async function fetchText(url){
      const res = await fetch(url + "?t=" + Date.now(), { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status + " for " + url);
      return res.text();
    }
    async function fetchXML(){
      const txt = await fetchText(XML_URL);
      const xml = new DOMParser().parseFromString(txt,"application/xml");
      if (xml.querySelector("parsererror")) throw new Error("XML parse error");
      return xml;
    }
    async function fetchImagesMap(){
      try{
        const csvTxt = await fetchText(IMAGES_CSV_URL);
        const parsed = Papa.parse(csvTxt, { header:true, skipEmptyLines:true });
        IMG_MAP.clear();
        (parsed.data||[]).forEach(row=>{
          const sku=(row.sku||"").trim(); const url=(row.url||"").trim();
          if(sku && url && url!=="-") IMG_MAP.set(sku, url);
        });
      }catch(e){ console.warn("images.csv not loaded:", e.message); IMG_MAP.clear(); }
    }
    async function fetchDetailsMap(){
      try{
        const csvTxt = await fetchText(DETAILS_CSV_URL);
        const parsed = Papa.parse(csvTxt, { header:true, skipEmptyLines:false });
        DETAIL_MAP.clear();
        (parsed.data||[]).forEach(row=>{
          const sku=(row.sku||"").trim();
          if(!sku) return;
          DETAIL_MAP.set(sku, {
            tech: (row.tech||"").trim(),
            log: (row.log||"").trim(),
            marketing: (row.marketing||"").trim(),
            add: (row.add||"").trim()
          });
        });
      }catch(e){ console.warn("add_data.csv not loaded:", e.message); DETAIL_MAP.clear(); }
    }

    // Parse XML
    function parseOffers(xml){
      const offers = getByLocalName(xml, "offer").map(offer=>{
        const sku = offer.getAttribute("sku") || "";
        const model = (firstByLocalName(offer, "model")?.textContent || "").trim();
        const modelLC = model.toLowerCase();
        const av = firstByLocalName(offer, "availability");
        const stock = Number(av?.getAttribute("stockCount") || "0");
        const price = Number((firstByLocalName(offer, "price")?.textContent || "0").replace(/[^\d]/g,""));
        return { sku, model, modelLC, stock, price };
      });
      return offers;
    }

    // Sorting & filtering
    function sortOffers(arr){
      switch (sortKey.value){
        case "price_desc": return arr.slice().sort((a,b)=> b.price - a.price);
        case "price_asc":  return arr.slice().sort((a,b)=> a.price - b.price);
        case "stock_desc": return arr.slice().sort((a,b)=> b.stock - a.stock);
        case "stock_asc":  return arr.slice().sort((a,b)=> a.stock - b.stock);
        default:           return arr.slice().sort((a,b)=> (b.stock-a.stock) || a.model.localeCompare(b.model));
      }
    }
    function currentFiltered(){
      const term = q.value.trim().toLowerCase();
      return OFFERS.filter(o=>{
        const hit = o.sku.includes(term) || o.modelLC.includes(term);
        return hit && (!onlyInStock.checked || o.stock>0);
      });
    }

    // Rendering: LIST
    function renderList(){
      viewList.hidden=false; viewDetail.hidden=true;
      const data = sortOffers(currentFiltered());
      list.innerHTML="";
      if(!data.length){
        list.innerHTML = `<div class="card"><div class="model">Ничего не найдено. Попробуйте другой артикул или модель.</div></div>`;
      }else{
        const imgsOn = showImages.checked;
        const frag = document.createDocumentFragment();
        for(const o of data){
          const {label, cls} = stockBucket(o.stock);
          const imgUrl = IMG_MAP.get(o.sku) || "";
          const hasDetails = DETAIL_MAP.has(o.sku);

          const card = document.createElement("div");
          card.className = "card";
          if (o.stock === 0) card.classList.add("oos");

          card.innerHTML = `
            <div class="row1">
              <div class="sku">Артикул: ${o.sku}</div>
              <span class="badge ${cls}"><span class="badge-dot"></span>${label}</span>
            </div>
            <div class="model">${o.model}</div>
            <div class="micro">
              ${hasDetails ? `
                <a href="#sku=${encodeURIComponent(o.sku)}">Подробнее</a>
                · <a href="#sku=${encodeURIComponent(o.sku)}&tab=tech">Тех</a>
                · <a href="#sku=${encodeURIComponent(o.sku)}&tab=log">Лог</a>
                · <a href="#sku=${encodeURIComponent(o.sku)}&tab=marketing">Маркетинг</a>
              ` : `<span style="color:#6b7280">Описание отсутствует</span>`}
            </div>
            <div class="meta">
              <div class="leftMeta">
                ${imgUrl && imgsOn ? `<img class="thumb" loading="lazy" src="${imgUrl}" alt="${o.model}">` : ``}
              </div>
              <div class="price">${formatTenge(o.price)}</div>
            </div>
          `;
          if (imgUrl && imgsOn){
            const img = card.querySelector(".thumb");
            img?.addEventListener("click", ()=>{ lightboxImg.src = imgUrl; lightbox.style.display='flex'; });
          }
          frag.appendChild(card);
        }
        list.appendChild(frag);
      }
      stats.textContent = `Показано ${data.length} / ${OFFERS.length} ${onlyInStock.checked?"(только в наличии)":""}${showImages.checked?"":" • изображения скрыты"}`;
    }

    // Sanitize bullets
    function sanitizeBullets(addStr){
      return (addStr||"")
        .split(/\r?\n|[|;]+/g)
        .map(s=>s.trim())
        .filter(Boolean);
    }

    // Rendering: DETAIL
    function renderDetail(sku, tab="details"){
      viewList.hidden=true; viewDetail.hidden=false;

      const o = OFFERS.find(x=>x.sku===sku);
      const d = DETAIL_MAP.get(sku) || {tech:"",log:"",marketing:"",add:""};
      const imgUrl = IMG_MAP.get(sku) || "";
      const {label, cls} = o ? stockBucket(o.stock) : {label:"", cls:""};

      detailHead.className = "head" + ((o && o.stock===0) ? " oos" : "");
      detailHead.innerHTML = `
        <div class="hrow">
          <div class="title1">${o ? `Артикул: ${o.sku}` : sku}</div>
          ${label ? `<span class="badge ${cls}"><span class="badge-dot"></span>${label}</span>` : ""}
        </div>
        <div class="hrow">
          <div>${o ? o.model : ""}</div>
          <div class="price">${o ? formatTenge(o.price) : ""}</div>
        </div>
        <div class="hero">
          ${imgUrl ? `<img id="heroImg" loading="lazy" src="${imgUrl}" alt="${o?o.model:""}">` : ""}
        </div>
      `;
      const heroImg = document.getElementById("heroImg");
      if (heroImg) heroImg.addEventListener("click", ()=>{ lightboxImg.src=imgUrl; lightbox.style.display='flex'; });

      const tabs = [
        {id:"details", label:"Подробнее"},
        {id:"tech", label:"Тех"},
        {id:"log", label:"Лог"},
        {id:"marketing", label:"Маркетинг"}
      ];
      tabsEl.innerHTML = "";
      tabs.forEach(t=>{
        const b=document.createElement("button");
        b.className="tabbtn" + (t.id===tab?" active":"");
        b.textContent=t.label;
        b.addEventListener("click", ()=>{
          const base = `#sku=${encodeURIComponent(sku)}`;
          location.replace(t.id==="details" ? base : `${base}&tab=${t.id}`);
        });
        tabsEl.appendChild(b);
      });

      let html = "";
      if (tab==="details"){
        const bullets = sanitizeBullets(d.add);
        html += bullets.length
          ? `<div class="block"><ul class="bullets">${bullets.map(x=>`<li>${x}</li>`).join("")}</ul></div>`
          : `<div class="muted" style="color:#6b7280">Нет кратких пунктов</div>`;
      }
      if (tab==="tech"){
        html += d.tech ? `<div class="block"><pre>${d.tech}</pre></div>` : `<div class="muted" style="color:#6b7280">Нет данных</div>`;
      }
      if (tab==="log"){
        html += d.log ? `<div class="block"><pre>${d.log}</pre></div>` : `<div class="muted" style="color:#6b7280">Нет данных</div>`;
      }
      if (tab==="marketing"){
        html += d.marketing ? `<div class="block" style="background:var(--bg);border-color:#e5e7eb"><div style="white-space:pre-wrap;margin:0">${d.marketing}</div></div>` : `<div class="muted" style="color:#6b7280">Нет данных</div>`;
      }
      tabpanel.innerHTML = html;
    }

    // Exports
    function exportExcel(rows){
      const out = rows.map(o=>{
        const b = stockBucket(o.stock);
        const d = DETAIL_MAP.get(o.sku) || {};
        return { Артикул:o.sku, Модель:o.model, Индикатор:b.label, Цена:o.price,
                 Изображение: IMG_MAP.get(o.sku)||"", Тех:d.tech||"", Лог:d.log||"",
                 Маркетинг:d.marketing||"", Подробнее:d.add||"" };
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(out);
      ws["!cols"] = [{wch:12},{wch:50},{wch:14},{wch:12},{wch:40},{wch:40},{wch:40},{wch:40},{wch:40}];
      XLSX.utils.book_append_sheet(wb, ws, "Прайс");
      XLSX.writeFile(wb, "einhell_price_public.xlsx");
    }
    function exportCSV(rows){
      const header = ["Артикул","Модель","Индикатор","Цена","Изображение","Тех","Лог","Маркетинг","Подробнее"];
      const lines = [header.map(escCSV).join(",")];
      for(const o of rows){
        const b = stockBucket(o.stock);
        const d = DETAIL_MAP.get(o.sku) || {};
        lines.push([
          o.sku, o.model, b.label, o.price, IMG_MAP.get(o.sku)||"", d.tech||"", d.log||"", d.marketing||"", d.add||""
        ].map(escCSV).join(","));
      }
      downloadBlob("einhell_price_public.csv", "text/csv;charset=utf-8", lines.join("\n"));
    }
    function exportJSON(rows){
      const arr = rows.map(o=>{
        const b = stockBucket(o.stock);
        const d = DETAIL_MAP.get(o.sku) || {};
        return { sku:o.sku, model:o.model, indicator:b.label, price:o.price,
                 image: IMG_MAP.get(o.sku)||null, tech:d.tech||"", log:d.log||"",
                 marketing:d.marketing||"", details:d.add||"" };
      });
      downloadBlob("einhell_price_public.json", "application/json;charset=utf-8", JSON.stringify(arr, null, 2));
    }
    function exportXML(rows){
      const esc = s => String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
      let xml = `<?xml version="1.0" encoding="UTF-8"?><items>`;
      for(const o of rows){
        const b = stockBucket(o.stock);
        const d = DETAIL_MAP.get(o.sku) || {};
        const img = IMG_MAP.get(o.sku)||"";
        xml += `<item sku="${esc(o.sku)}"><model>${esc(o.model)}</model><indicator>${esc(b.label)}</indicator><price>${o.price}</price>${img?`<image>${esc(img)}</image>`:""}<tech>${esc(d.tech||"")}</tech><log>${esc(d.log||"")}</log><marketing>${esc(d.marketing||"")}</marketing><details>${esc(d.add||"")}</details></item>`;
      }
      xml += `</items>`;
      downloadBlob("einhell_price_public.xml", "application/xml;charset=utf-8", xml);
    }

    // Router
    function parseHash(){
      const h = location.hash.replace(/^#/,"");
      if (h.includes("sku=")){
        const sp = new URLSearchParams(h);
        return { sku: sp.get("sku"), tab: (sp.get("tab")||"details") };
      }
      return { sku:null, tab:null };
    }
    function renderRoute(){
      const {sku, tab} = parseHash();
      if (sku){ renderDetail(sku, tab||"details"); } else { renderList(); }
    }

    // Init
    async function init(){
      try{
        stats.textContent="Загрузка…";
        await Promise.all([fetchImagesMap(), fetchDetailsMap()]);
        const xml = await fetchXML();
        OFFERS = parseOffers(xml);
        if (OFFERS.length === 0) throw new Error("Parsed 0 offers (namespace?)");
        footer.textContent = "Обновлено: " + new Date().toLocaleString();
        errorBox.hidden = true;
        renderRoute();
      }catch(err){
        console.error(err);
        errorBox.hidden = false;
        errorBox.textContent = "Не удалось загрузить: " + err.message;
        stats.textContent = "—";
      }
    }

    // Events
    q.addEventListener("input",debounce(()=>{ if(!location.hash) renderList(); },220));
    onlyInStock.addEventListener("change",()=>{ if(!location.hash) renderList(); });
    showImages.addEventListener("change",()=>{ if(!location.hash) renderList(); });
    sortKey.addEventListener("change",()=>{ if(!location.hash) renderList(); });
    clearBtn.addEventListener("click",()=>{ q.value=""; if(!location.hash) { renderList(); q.focus(); } });

    btnDownload.addEventListener("click", ()=>{
      const rows = sortOffers(currentFiltered());
      switch(downloadFmt.value){
        case "xlsx": return exportExcel(rows);
        case "csv":  return exportCSV(rows);
        case "json": return exportJSON(rows);
        case "xml":  return exportXML(rows);
      }
    });

    btnBack.addEventListener("click", ()=>{
      location.replace("#");
      renderList();
    });

    window.addEventListener("hashchange", renderRoute);

    setInterval(init,30*60*1000);
    init();
  </script>
</body>
</html>
  
