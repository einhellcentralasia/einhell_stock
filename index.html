<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Остатки Einhell - Внутренние</title>
  <meta name="description" content="Быстрый поиск остатков по артикулу или модели (Einhell)" />
  <!-- SheetJS for Excel export (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- PapaParse for robust CSV parsing (multiline, quoted) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --brand:#E2001A; --ink:#111111; --bg:#ffffff; --card:#f8f9fb;
      --muted:#6b7280; --ok:#2e7d32; --warn:#b91c1c; --accent:#111111;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}

    /* HEADER */
    header{
      position:sticky;top:0;z-index:10;background:var(--brand);color:#fff;
      padding:10px 14px;box-shadow:0 2px 6px rgba(0,0,0,.15);display:flex;align-items:center;gap:10px
    }
    .logo{height:28px;width:auto;display:block;background:#fff;padding:4px;border-radius:6px}
    .titles{display:flex;flex-direction:column;gap:2px}
    .title{font-weight:800;font-size:18px;letter-spacing:.2px}
    .sub{font-size:12px;opacity:.95}

    /* CONTROLS */
    .controls{padding:10px 12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:#fff;border-bottom:1px solid #eee}
    .search{flex:1 1 260px;position:relative}
    .search input{width:100%;padding:12px 40px 12px 12px;font-size:16px;border:1px solid #e5e7eb;border-radius:10px;outline:none}
    .clear-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);border:none;background:transparent;font-size:18px;cursor:pointer;color:#9ca3af;padding:6px}
    .toggle{display:flex;align-items:center;gap:8px;font-size:14px;color:#374151}
    .sort{display:flex;align-items:center;gap:6px}
    select{padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .btn{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer}
    .btn:active{transform:scale(0.99)}

    /* LIST */
    .stats{padding:6px 14px;font-size:13px;color:var(--muted)}
    .list{padding:8px 10px 18px;display:grid;gap:10px}
    .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .card.oos{opacity:.45;filter:grayscale(100%)} /* Out-of-stock visual dim */
    .row1{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .sku{font-weight:800;font-size:15px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;font-weight:700;color:#fff;white-space:nowrap}
    .ok{background:var(--ok)} .no{background:var(--warn)}
    .model{margin:6px 0 6px;font-size:14px}
    .micro{font-size:12px;color:#2563eb;display:flex;gap:10px;flex-wrap:wrap}
    .micro a{color:#2563eb;text-decoration:none}
    .micro a:hover{text-decoration:underline}

    .meta{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .leftMeta{display:flex;align-items:center;gap:12px}
    .thumb{width:70px;height:70px;object-fit:contain;background:#fff;border-radius:10px;border:1px solid #eee;cursor:pointer}
    .thumb[hidden]{display:none}
    .price{color:var(--accent);font-weight:800}
    .stock{font-weight:800}

    @media(min-width:760px){.list{grid-template-columns:repeat(2,1fr)} .card{padding:14px}}
    @media(min-width:1100px){.list{grid-template-columns:repeat(3,1fr)}}

    /* DETAIL PAGE */
    .detail{padding:12px}
    .detail .topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .back{border:none;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;cursor:pointer}
    .detail .head{background:var(--card);border-radius:var(--radius);padding:12px;display:grid;gap:10px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .detail .head.oos{opacity:.65;filter:grayscale(100%)}
    .detail .hrow{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .detail .title1{font-weight:800}
    .detail .hero{display:flex;gap:14px;align-items:center}
    .detail .hero img{width:120px;height:120px;object-fit:contain;background:#fff;border-radius:10px;border:1px solid #eee;cursor:pointer}

    .tabs{margin-top:12px;display:flex;gap:6px;flex-wrap:wrap}
    .tabbtn{padding:8px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;cursor:pointer;font-size:13px}
    .tabbtn.active{background:#111;color:#fff;border-color:#111}
    .tabpanel{margin-top:10px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
    .chip{background:#eef2ff;color:#1e3a8a;border:1px solid #dbeafe;border-radius:999px;padding:4px 8px;font-size:12px}
    pre.block{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#f9fafb;border:1px solid #eee;border-radius:8px;padding:10px}

    .footer{padding:20px 14px;text-align:center;color:var(--muted);font-size:12px}
    .error{color:var(--warn);padding:12px 14px}

    /* Lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:50}
    .lightbox img{max-width:92vw;max-height:90vh;background:#fff;border-radius:10px;padding:6px}
  </style>
</head>
<body>
  <header>
    <img class="logo" src="logo.png" alt="Einhell" onerror="this.style.display='none'">
    <div class="titles">
      <div class="title">Остатки Einhell</div>
      <div class="sub">Поиск по артикулу или модели.</div>
    </div>
  </header>

  <!-- LIST VIEW -->
  <div id="view-list">
    <div class="controls">
      <div class="search">
        <input id="q" type="text" placeholder="Ввести Артикул (например, 4513812) или Модель (например, TE-CD 18/40)…" autocomplete="off" />
        <button class="clear-btn" id="clear" title="Очистить">✕</button>
      </div>

      <label class="toggle"><input type="checkbox" id="onlyInStock" /> Только в наличии</label>
      <label class="toggle"><input type="checkbox" id="showImages" /> Вкл. изображения</label>

      <div class="sort">
        <select id="sortKey" title="Сортировка">
          <option value="default">Сортировка: по умолчанию</option>
          <option value="price_desc">Цена ↓</option>
          <option value="price_asc">Цена ↑</option>
          <option value="stock_desc">Остаток ↓</option>
          <option value="stock_asc">Остаток ↑</option>
        </select>
      </div>

      <div class="sort">
        <select id="downloadFmt" title="Формат выгрузки">
          <option value="xlsx">Excel (.xlsx)</option>
          <option value="csv">CSV (.csv)</option>
          <option value="json">JSON (.json)</option>
          <option value="xml">XML (.xml)</option>
        </select>
        <button class="btn" id="btnDownload">Скачать</button>
      </div>
    </div>

    <div class="stats" id="stats">Загрузка…</div>
    <div class="error" id="error" hidden></div>
    <div class="list" id="list"></div>
  </div>

  <!-- DETAIL VIEW -->
  <div id="view-detail" class="detail" hidden>
    <div class="topbar">
      <button class="back" id="btnBack">← Назад</button>
    </div>
    <div id="detail-head" class="head"></div>
    <div class="tabs" id="tabs"></div>
    <div class="tabpanel" id="tabpanel"></div>
  </div>

  <div class="footer" id="footer"></div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" onclick="this.style.display='none'">
    <img id="lightboxImg" alt="preview">
  </div>

  <script>
    // ---- Config / URLs ----
    const XML_URL = "https://einhellcentralasia.github.io/kaspi_stock/price.xml";
    const IMAGES_CSV_URL = "./images.csv";     // sku,url
    const DETAILS_CSV_URL = "./add_data.csv";  // sku,tech,log,marketing,add

    // ---- Helpers ----
    function formatTenge(n){ if (isNaN(n)) return n; return new Intl.NumberFormat("ru-KZ",{maximumFractionDigits:0}).format(Number(n)) + " ₸"; }
    function debounce(fn,ms=220){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
    function getByLocalName(node, local){ return Array.from(node.getElementsByTagNameNS("*", local)); }
    function firstByLocalName(node, local){ const a=getByLocalName(node, local); return a.length?a[0]:null; }
    function escCSV(v){ const s=String(v??""); return /[",;\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
    function downloadBlob(filename, mime, data){ const blob=new Blob([data],{type:mime}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove(); }

    // ---- DOM ----
    const viewList = document.getElementById("view-list");
    const viewDetail = document.getElementById("view-detail");
    const q=document.getElementById("q");
    const clearBtn=document.getElementById("clear");
    const onlyInStock=document.getElementById("onlyInStock");
    const showImages=document.getElementById("showImages");
    const sortKey=document.getElementById("sortKey");
    const downloadFmt=document.getElementById("downloadFmt");
    const btnDownload=document.getElementById("btnDownload");
    const list=document.getElementById("list");
    const stats=document.getElementById("stats");
    const errorBox=document.getElementById("error");
    const footer=document.getElementById("footer");
    const lightbox=document.getElementById("lightbox");
    const lightboxImg=document.getElementById("lightboxImg");
    const btnBack=document.getElementById("btnBack");
    const detailHead=document.getElementById("detail-head");
    const tabsEl=document.getElementById("tabs");
    const tabpanel=document.getElementById("tabpanel");

    // ---- Data ----
    let OFFERS=[];          // {sku, model, modelLC, available, stock, price}
    let IMG_MAP=new Map();  // sku -> url
    let DETAIL_MAP=new Map(); // sku -> {tech,log,marketing,add, bullets?}

    // ---- Fetchers ----
    async function fetchText(url){
      const res = await fetch(url + "?t=" + Date.now(), { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status + " for " + url);
      return res.text();
    }
    async function fetchXML(){
      const txt = await fetchText(XML_URL);
      const xml = new DOMParser().parseFromString(txt,"application/xml");
      if (xml.querySelector("parsererror")) throw new Error("XML parse error");
      return xml;
    }
    async function fetchImagesMap(){
      try{
        const csvTxt = await fetchText(IMAGES_CSV_URL);
        const parsed = Papa.parse(csvTxt, { header:true, skipEmptyLines:true });
        IMG_MAP.clear();
        (parsed.data||[]).forEach(row=>{
          const sku=(row.sku||"").trim(); const url=(row.url||"").trim();
          if(sku && url && url!=="-") IMG_MAP.set(sku, url);
        });
      }catch(e){ console.warn("images.csv not loaded:", e.message); IMG_MAP.clear(); }
    }
    async function fetchDetailsMap(){
      try{
        const csvTxt = await fetchText(DETAILS_CSV_URL);
        const parsed = Papa.parse(csvTxt, { header:true, skipEmptyLines:false });
        DETAIL_MAP.clear();
        (parsed.data||[]).forEach(row=>{
          const sku=(row.sku||"").trim();
          if(!sku) return;
          DETAIL_MAP.set(sku, {
            tech: (row.tech||"").trim(),
            log: (row.log||"").trim(),
            marketing: (row.marketing||"").trim(),
            add: (row.add||"").trim()
          });
        });
      }catch(e){ console.warn("add_data.csv not loaded:", e.message); DETAIL_MAP.clear(); }
    }

    // ---- Parsers & Sorting ----
    function parseOffers(xml){
      const offers = getByLocalName(xml, "offer").map(offer=>{
        const sku = offer.getAttribute("sku") || "";
        const model = (firstByLocalName(offer, "model")?.textContent || "").trim();
        const modelLC = model.toLowerCase();
        const av = firstByLocalName(offer, "availability");
        const available = (av?.getAttribute("available") || "no").toLowerCase()==="yes";
        const stock = Number(av?.getAttribute("stockCount") || "0");
        const price = Number((firstByLocalName(offer, "price")?.textContent || "0").replace(/[^\d]/g,""));
        return { sku, model, modelLC, available, stock, price };
      });
      return offers;
    }
    function sortOffers(arr){
      switch (sortKey.value){
        case "price_desc": return arr.slice().sort((a,b)=> b.price - a.price);
        case "price_asc":  return arr.slice().sort((a,b)=> a.price - b.price);
        case "stock_desc": return arr.slice().sort((a,b)=> b.stock - a.stock);
        case "stock_asc":  return arr.slice().sort((a,b)=> a.stock - b.stock);
        default:           return arr.slice().sort((a,b)=>(b.available-a.available)||(b.stock-a.stock)||a.model.localeCompare(b.model));
      }
    }
    function currentFiltered(){
      const term = q.value.trim().toLowerCase();
      return OFFERS.filter(o=>{
        const hit = o.sku.includes(term) || o.modelLC.includes(term);
        return hit && (!onlyInStock.checked || o.stock>0);
      });
    }

    // ---- Rendering: LIST ----
    function renderList(){
      viewList.hidden=false; viewDetail.hidden=true;
      const data = sortOffers(currentFiltered());
      list.innerHTML="";
      if(!data.length){
        list.innerHTML = `<div class="card"><div class="model">Ничего не найдено. Попробуйте другой артикул или модель.</div></div>`;
      }else{
        const imgsOn = showImages.checked;
        const frag = document.createDocumentFragment();
        for(const o of data){
          const card = document.createElement("div");
          card.className = "card";
          if (o.stock===0) card.classList.add("oos");
          const badgeClass=o.stock>0?"ok":"no";
          const badgeText=o.stock>0?"В наличии":"Нет в наличии";
          const imgUrl = IMG_MAP.get(o.sku) || "";
          const hasDetails = DETAIL_MAP.has(o.sku);

          card.innerHTML = `
            <div class="row1">
              <div class="sku">Артикул: ${o.sku}</div>
              <span class="badge ${badgeClass}">${badgeText}</span>
            </div>
            <div class="model">${o.model}</div>
            <div class="micro">
              ${hasDetails ? `
                <a href="#sku=${encodeURIComponent(o.sku)}">Подробнее</a>
                · <a href="#sku=${encodeURIComponent(o.sku)}&tab=tech">Тех</a>
                · <a href="#sku=${encodeURIComponent(o.sku)}&tab=log">Лог</a>
                · <a href="#sku=${encodeURIComponent(o.sku)}&tab=marketing">Маркетинг</a>
              ` : `<span style="color:#6b7280">Нет доп. данных</span>`}
            </div>
            <div class="meta">
              <div class="leftMeta">
                ${imgUrl && imgsOn ? `<img class="thumb" loading="lazy" src="${imgUrl}" alt="${o.model}">` : ``}
                <div class="stock">Кол-во: ${o.stock}</div>
              </div>
              <div class="price">${formatTenge(o.price)}</div>
            </div>
          `;
          if (imgUrl && imgsOn){
            const img = card.querySelector(".thumb");
            img?.addEventListener("click", ()=>{ lightboxImg.src = imgUrl; lightbox.style.display='flex'; });
          }
          frag.appendChild(card);
        }
        list.appendChild(frag);
      }
      stats.textContent = `Показано ${data.length} / ${OFFERS.length} ${onlyInStock.checked?"(только в наличии)":""}${showImages.checked?"":" • изображения скрыты"}`;
    }

    // ---- Rendering: DETAIL ----
    function renderDetail(sku, tab="highlights"){
      viewList.hidden=true; viewDetail.hidden=false;

      const o = OFFERS.find(x=>x.sku===sku);
      const d = DETAIL_MAP.get(sku) || {tech:"",log:"",marketing:"",add:""};
      const imgUrl = IMG_MAP.get(sku) || "";

      detailHead.className = "head" + ((o && o.stock===0) ? " oos" : "");
      const badge = o ? (o.stock>0 ? `<span class="badge ok">В наличии</span>` : `<span class="badge no">Нет в наличии</span>`) : "";
      detailHead.innerHTML = `
        <div class="hrow">
          <div class="title1">${o ? `Артикул: ${o.sku}` : sku}</div>
          ${badge}
        </div>
        <div class="hrow">
          <div>${o ? o.model : ""}</div>
          <div class="price">${o ? formatTenge(o.price) : ""}</div>
        </div>
        <div class="hero">
          ${imgUrl ? `<img id="heroImg" loading="lazy" src="${imgUrl}" alt="${o?o.model:""}">` : ""}
          ${o ? `<div class="muted">Остаток: ${o.stock}</div>` : ""}
        </div>
      `;
      const heroImg = document.getElementById("heroImg");
      if (heroImg) heroImg.addEventListener("click", ()=>{ lightboxImg.src=imgUrl; lightbox.style.display='flex'; });

      // Tabs
      const tabs = [
        {id:"highlights", label:"Highlights"},
        {id:"tech", label:"Тех"},
        {id:"log", label:"Лог"},
        {id:"marketing", label:"Маркетинг"},
        {id:"add", label:"Дополнительно"}
      ];
      tabsEl.innerHTML = "";
      tabs.forEach(t=>{
        const b=document.createElement("button");
        b.className="tabbtn" + (t.id===tab?" active":"");
        b.textContent=t.label;
        b.addEventListener("click", ()=>{
          const base = `#sku=${encodeURIComponent(sku)}`;
          location.hash = t.id==="highlights" ? base : `${base}&tab=${t.id}`;
        });
        tabsEl.appendChild(b);
      });

      // Tab content
      const chips = (d.add||"").split(/\s*\|\s*|\s*;\s*/).filter(Boolean);
      let html = "";
      if (tab==="highlights"){
        html += chips.length ? `<div class="chips">${chips.map(c=>`<span class="chip">${c}</span>`).join("")}</div>` : `<div class="muted" style="color:#6b7280">Нет кратких пунктов</div>`;
      }
      if (tab==="tech"){
        html += d.tech ? `<pre class="block">${d.tech}</pre>` : `<div class="muted" style="color:#6b7280">Нет данных</div>`;
      }
      if (tab==="log"){
        html += d.log ? `<pre class="block">${d.log}</pre>` : `<div class="muted" style="color:#6b7280">Нет данных</div>`;
      }
      if (tab==="marketing"){
        // allow mild HTML (links, <br>) if you include any in CSV; otherwise it renders as plain text
        html += d.marketing ? `<div style="white-space:pre-wrap">${d.marketing}</div>` : `<div class="muted" style="color:#6b7280">Нет данных</div>`;
      }
      if (tab==="add"){
        html += (d.add && !chips.length) ? `<pre class="block">${d.add}</pre>` : (!d.add ? `<div class="muted" style="color:#6b7280">Нет данных</div>` : `<div class="muted" style="color:#6b7280">См. Highlights</div>`);
      }
      tabpanel.innerHTML = html;
    }

    // ---- Exports ----
    function exportExcel(rows){
      const out = rows.map(o=>({ Артикул:o.sku, Модель:o.model, Остаток:o.stock, Цена:o.price, Изображение: IMG_MAP.get(o.sku)||"" }));
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(out);
      ws["!cols"] = [{wch:12},{wch:50},{wch:10},{wch:12},{wch:60}];
      XLSX.utils.book_append_sheet(wb, ws, "Прайс");
      XLSX.writeFile(wb, "einhell_price.xlsx");
    }
    function exportCSV(rows){
      const header = ["Артикул","Модель","Остаток","Цена","Изображение"];
      const lines = [header.map(escCSV).join(",")];
      for(const o of rows){ lines.push([o.sku, o.model, o.stock, o.price, IMG_MAP.get(o.sku)||""].map(escCSV).join(",")); }
      downloadBlob("einhell_price.csv", "text/csv;charset=utf-8", lines.join("\n"));
    }
    function exportJSON(rows){
      const arr = rows.map(o=>({sku:o.sku, model:o.model, stock:o.stock, price:o.price, image: IMG_MAP.get(o.sku)||null}));
      downloadBlob("einhell_price.json", "application/json;charset=utf-8", JSON.stringify(arr, null, 2));
    }
    function exportXML(rows){
      const esc = s => String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
      let xml = `<?xml version="1.0" encoding="UTF-8"?><items>`;
      for(const o of rows){
        const img = IMG_MAP.get(o.sku)||"";
        xml += `<item sku="${esc(o.sku)}"><model>${esc(o.model)}</model><stock>${o.stock}</stock><price>${o.price}</price>${img?`<image>${esc(img)}</image>`:""}</item>`;
      }
      xml += `</items>`;
      downloadBlob("einhell_price.xml", "application/xml;charset=utf-8", xml);
    }

    // ---- Router ----
    function parseHash(){
      const h = location.hash.replace(/^#/,"");
      const params = new URLSearchParams(h.replace(/^.+?\?/,"")); // fallback
      // Accept formats: "sku=123&tab=tech" or just "sku=123"
      if (h.includes("sku=")){
        const sp = new URLSearchParams(h);
        return { sku: sp.get("sku"), tab: (sp.get("tab")||"highlights") };
      }
      // Quick links "#sku=123&tab=tech" handled above
      // If user types "#sku=123&tab=tech" it's fine
      return { sku:null, tab:null };
    }
    function renderRoute(){
      const {sku, tab} = parseHash();
      if (sku){
        renderDetail(sku, tab||"highlights");
      }else{
        renderList();
      }
    }

    // ---- Init & Events ----
    async function init(){
      try{
        stats.textContent="Загрузка…";
        await Promise.all([fetchImagesMap(), fetchDetailsMap()]);
        const xml = await fetchXML();
        OFFERS = parseOffers(xml);
        if (OFFERS.length === 0) throw new Error("Parsed 0 offers (namespace?)");
        footer.textContent = "Обновлено: " + new Date().toLocaleString();
        errorBox.hidden = true;
        renderRoute();
      }catch(err){
        console.error(err);
        errorBox.hidden = false;
        errorBox.textContent = "Не удалось загрузить: " + err.message;
        stats.textContent = "—";
      }
    }

    // List view events
    q.addEventListener("input",debounce(()=>{ if(!location.hash) renderList(); },220));
    onlyInStock.addEventListener("change",()=>{ if(!location.hash) renderList(); });
    showImages.addEventListener("change",()=>{ if(!location.hash) renderList(); });
    sortKey.addEventListener("change",()=>{ if(!location.hash) renderList(); });
    clearBtn.addEventListener("click",()=>{ q.value=""; if(!location.hash) { renderList(); q.focus(); } });

    btnDownload.addEventListener("click", ()=>{
      const rows = sortOffers(currentFiltered());
      switch(downloadFmt.value){
        case "xlsx": return exportExcel(rows);
        case "csv":  return exportCSV(rows);
        case "json": return exportJSON(rows);
        case "xml":  return exportXML(rows);
      }
    });

    // Detail view events
    btnBack.addEventListener("click", ()=> history.back());

    window.addEventListener("hashchange", renderRoute);

    // Auto-refresh every 30 min
    setInterval(init,30*60*1000);

    // Go!
    init();
  </script>
</body>
</html>
