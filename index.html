<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Остатки Einhell</title>
  <meta name="description" content="Быстрый поиск остатков по артикулу или модели (Einhell)" />
  <style>
    :root{
      /* Einhell palette */
      --brand:#E2001A;   /* Einhell red */
      --ink:#111111;     /* near-black text */
      --bg:#ffffff;
      --card:#f8f9fb;
      --muted:#6b7280;
      --ok:#2e7d32;
      --warn:#b91c1c;
      --accent:#111111;  /* price in black to match brand */
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    /* HEADER */
    header{
      position:sticky;top:0;z-index:10;background:var(--brand);color:#fff;
      padding:10px 14px;box-shadow:0 2px 6px rgba(0,0,0,.15);display:flex;align-items:center;gap:10px
    }
    .logo{
      height:28px;width:auto;display:block;background:#fff;padding:4px;border-radius:6px;
    }
    .titles{display:flex;flex-direction:column;gap:2px}
    .title{font-weight:800;font-size:18px;letter-spacing:.2px}
    .sub{font-size:12px;opacity:.95}
    /* CONTROLS */
    .controls{padding:10px 12px;display:flex;gap:8px;align-items:center;background:#fff;border-bottom:1px solid #eee}
    .search{flex:1;position:relative}
    .search input{width:100%;padding:12px 40px 12px 12px;font-size:16px;border:1px solid #e5e7eb;border-radius:10px;outline:none}
    .clear-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);border:none;background:transparent;font-size:18px;cursor:pointer;color:#9ca3af;padding:6px}
    .toggle{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted)}
    /* INFO & LIST */
    .stats{padding:6px 14px;font-size:13px;color:var(--muted)}
    .list{padding:8px 10px 18px;display:grid;gap:10px}
    .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .row1{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .sku{font-weight:800;font-size:15px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;font-weight:700;color:#fff;white-space:nowrap}
    .ok{background:var(--ok)} .no{background:var(--warn)}
    .model{margin:6px 0 8px;font-size:14px}
    .meta{display:flex;gap:16px;font-size:14px}
    .price{color:var(--accent);font-weight:800}
    .stock{font-weight:800}
    @media(min-width:760px){.list{grid-template-columns:repeat(2,1fr)} .card{padding:14px}}
    @media(min-width:1100px){.list{grid-template-columns:repeat(3,1fr)}}
    .footer{padding:20px 14px;text-align:center;color:var(--muted);font-size:12px}
    .error{color:var(--warn);padding:12px 14px}
  </style>
</head>
<body>
  <header>
    <!-- Upload logo.png into the repo root; if missing, the image auto-hides -->
    <img class="logo" src="logo.png" alt="Einhell" onerror="this.style.display='none'">
    <div class="titles">
      <div class="title">Остатки Einhell</div>
      <div class="sub">Поиск по артикулу или модели. Данные подгружаются из price.xml автоматически.</div>
    </div>
  </header>

  <div class="controls">
    <div class="search">
      <input id="q" type="text"
        placeholder="Ввести Артикул (например, 4513812) или Модель (например, TE-CD 18/40)…"
        autocomplete="off" />
      <button class="clear-btn" id="clear" title="Очистить">✕</button>
    </div>
    <label class="toggle">
      <input type="checkbox" id="onlyInStock" /> Только в наличии
    </label>
  </div>

  <div class="stats" id="stats">Загрузка…</div>
  <div class="error" id="error" hidden></div>
  <div class="list" id="list"></div>
  <div class="footer" id="footer"></div>

  <script>
    // XML lives in the other repo (same origin)
    const XML_URL = "https://einhellcentralasia.github.io/kaspi_stock/price.xml";

    // Helpers
    function formatTenge(n){
      if (isNaN(n)) return n;
      return new Intl.NumberFormat("ru-KZ",{maximumFractionDigits:0}).format(Number(n)) + " ₸";
    }
    function debounce(fn,ms=120){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
    // Namespace-agnostic queries (your XML uses a default namespace)
    function getByLocalName(node, local){ return Array.from(node.getElementsByTagNameNS("*", local)); }
    function firstByLocalName(node, local){ const a=getByLocalName(node, local); return a.length?a[0]:null; }

    // DOM refs
    const q=document.getElementById("q");
    const clearBtn=document.getElementById("clear");
    const onlyInStock=document.getElementById("onlyInStock");
    const list=document.getElementById("list");
    const stats=document.getElementById("stats");
    const errorBox=document.getElementById("error");
    const footer=document.getElementById("footer");

    let OFFERS=[];

    async function fetchXML(){
      const url = XML_URL + "?t=" + Date.now(); // cache-bust: always fresh from Pages CDN
      const res = await fetch(url,{cache:"no-store"});
      if(!res.ok) throw new Error("HTTP " + res.status);
      const txt = await res.text();
      const xml = new DOMParser().parseFromString(txt,"application/xml");
      if (xml.querySelector("parsererror")) throw new Error("XML parse error");
      return xml;
    }

    function parseOffers(xml){
      const offers = getByLocalName(xml, "offer").map(offer=>{
        const sku = offer.getAttribute("sku") || "";
        const model = (firstByLocalName(offer, "model")?.textContent || "").trim();
        const av = firstByLocalName(offer, "availability");
        const available = (av?.getAttribute("available") || "no").toLowerCase()==="yes";
        const stock = Number(av?.getAttribute("stockCount") || "0");
        const price = Number((firstByLocalName(offer, "price")?.textContent || "0").replace(/[^\d]/g,""));
        return { sku, model, available, stock, price };
      });
      // Sort: in-stock first, then by stock desc, then model
      return offers.sort((a,b)=>(b.available-a.available)||(b.stock-a.stock)||a.model.localeCompare(b.model));
    }

    function render(){
      const term = q.value.trim().toLowerCase();
      const filt = OFFERS.filter(o=>{
        const hit = o.sku.includes(term) || o.model.toLowerCase().includes(term);
        return hit && (!onlyInStock.checked || o.stock>0);
      });

      list.innerHTML="";
      if(!filt.length){
        list.innerHTML = `<div class="card"><div class="model">Ничего не найдено. Попробуйте другой артикул или модель.</div></div>`;
      }else{
        for(const o of filt){
          const badgeClass=o.stock>0?"ok":"no";
          const badgeText=o.stock>0?"В наличии":"Нет в наличии";
          list.insertAdjacentHTML("beforeend",`
            <div class="card">
              <div class="row1">
                <div class="sku">Артикул: ${o.sku}</div>
                <span class="badge ${badgeClass}">${badgeText}</span>
              </div>
              <div class="model">${o.model}</div>
              <div class="meta">
                <div class="stock">Кол-во: ${o.stock}</div>
                <div class="price">${formatTenge(o.price)}</div>
              </div>
            </div>
          `);
        }
      }
      stats.textContent = `Показано ${filt.length} / ${OFFERS.length} ${onlyInStock.checked?"(только в наличии)":""}`;
    }

    async function init(){
      try{
        stats.textContent="Загрузка…";
        const xml = await fetchXML();
        OFFERS = parseOffers(xml);
        if (OFFERS.length === 0) throw new Error("Parsed 0 offers (namespace?)");
        render();
        footer.textContent = "Обновлено: " + new Date().toLocaleString();
        errorBox.hidden = true;
      }catch(err){
        console.error(err);
        errorBox.hidden = false;
        errorBox.textContent = "Не удалось загрузить price.xml: " + err.message;
        stats.textContent = "—";
      }
    }

    // Events
    q.addEventListener("input",debounce(render,80));
    onlyInStock.addEventListener("change",render);
    clearBtn.addEventListener("click",()=>{q.value="";render();q.focus();});
    setInterval(init,30*60*1000); // авто-обновление каждые 30 минут

    // Start
    init();
  </script>
</body>
</html>
