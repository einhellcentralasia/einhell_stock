<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Остатки Einhell — Внутренние</title>
<meta name="description" content="Поиск остатков Einhell" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --brand:#E2001A;

    /* Light (iOS-like) */
    --bg:#ffffff; --bg2:#f5f5f7;
    --ink:#1c1c1e; --muted:#6b7280;
    --card:#f8f9fb; --border:#e5e7eb;
    --accent:#111111; --radius:14px; --shadow:0 1px 3px rgba(0,0,0,.08);
    --input:#fff; --inputText:#111;
    --ok:#2e7d32; --warn:#b91c1c; --over:#ef4444;
    --chip-bg:#e9ecef; --chip-ink:#111;

    --qty-bg:#111; --qty-ink:#fff;

    /* runtime offsets */
    --hdr-h:56px;
    --controls-top:56px;
    --drawer-head:52px;

    /* Icon theme colors */
    --icon-header-light:#111;
    --icon-header-dark:#f2f2f7;

    /* bulb tint helpers (used with filters on img) */
    --bulb-warm-filter: invert(53%) sepia(84%) saturate(1450%) hue-rotate(10deg) brightness(96%) contrast(102%);
    --bulb-cool-filter: invert(71%) sepia(13%) saturate(2213%) hue-rotate(208deg) brightness(101%) contrast(102%);
  }
  html[data-theme="dark"]{
    /* Dark (Apple graphite) */
    --bg:#1c1c1e; --bg2:#161618; --ink:#f2f2f7; --muted:#a1a1a6;
    --card:#2c2c2e; --border:#3a3a3c; --accent:#f2f2f7; --shadow:0 1px 3px rgba(0,0,0,.55);
    --input:#2c2c2e; --inputText:#f2f2f7;
    --chip-bg:#3a3a3c; --chip-ink:#f2f2f7;
    --qty-bg:#2c2c2e; --qty-ink:#f2f2f7;
  }
  *{box-sizing:border-box}
  html,body{max-width:100%;overflow-x:hidden}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--ink);background:var(--bg);padding-top:var(--hdr-h)
  }
  .hidden{display:none!important}
  .muted{color:var(--muted)}
  .no-scroll{overflow:hidden}
  .icon{width:22px;height:22px;display:inline-block;vertical-align:middle}

  /* Header (fixed) */
  header{
    position:fixed; inset:0 0 auto 0; z-index:1000;
    display:flex; align-items:center; gap:10px;
    background:var(--brand); color:#fff; padding:8px 12px;
    box-shadow:0 2px 6px rgba(0,0,0,.15);
  }
  .logo{height:28px;background:#fff;border-radius:6px;padding:4px}
  .hdr-spacer{flex:1}
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    background:var(--chip-bg); color:var(--chip-ink);
    padding:8px 14px; border-radius:14px; font-weight:800;
    box-shadow:inset 0 0 0 1px rgba(0,0,0,.05);
  }
  .hdr-btn{
    display:inline-flex; align-items:center; justify-content:center;
    width:48px; height:44px; border-radius:14px; border:0; cursor:pointer;
    background:var(--chip-bg); color:var(--icon-header-light); font-size:0;
  }
  html[data-theme="dark"] .hdr-btn{ color:var(--icon-header-dark); }
  #openCart.hdr-btn{ width:64px; }  /* a bit wider for the cart */

  /* Controls (sticky under header) */
  .controls{
    position:sticky; top:var(--controls-top); z-index:900;
    background:var(--bg); border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:10px; flex-wrap:wrap; padding:10px 10px
  }
  .search{flex:1 1 200px; max-width:420px; position:relative}
  .search input{
    width:100%; padding:10px 40px 10px 12px; border:1px solid var(--border);
    border-radius:10px; background:var(--input); color:var(--inputText)
  }
  .clear-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);border:none;background:transparent;cursor:pointer;padding:6px;color:#9ca3af}
  .group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  select{padding:9px 10px;border:1px solid var(--border);border-radius:10px;background:var(--input);color:var(--inputText)}
  .btn{padding:9px 12px;border:1px solid var(--border);border-radius:10px;background:var(--input);color:var(--inputText);cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .btn:active{transform:scale(.99)}

  /* Spacing under filters so the first cards are never hidden */
  #view-list{ margin-top:36px; }

  /* Stats & list */
  .stats{padding:6px 12px;font-size:13px;color:var(--muted);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .list{padding:8px 10px 18px;display:grid;gap:10px}
  .card{
    position:relative; z-index:1; overflow:hidden;
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    padding:12px; box-shadow:var(--shadow); display:grid; gap:8px;
    grid-template-rows:auto auto auto auto;
    transform:translateZ(0);
  }
  .card.oos{opacity:.45;filter:grayscale(100%)}
  .row1{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .sku{font-weight:800;font-size:16px}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;font-weight:700;color:#fff;white-space:nowrap}
  .ok{background:var(--ok)} .no{background:var(--warn)}
  .model{font-size:14px; line-height:1.35}
  .meta{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .leftMeta{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .thumb{width:70px;height:70px;object-fit:contain;background:#fff;border:1px solid var(--border);border-radius:10px;cursor:pointer}
  .price{color:var(--accent);font-weight:800}
  .stock{font-weight:800}

  /* Actions */
  .actions{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .ctrls{ display:flex; align-items:center; gap:10px; }

  .qtywrap{
    display:inline-flex; align-items:center; gap:12px;
    padding:8px 12px; background:var(--qty-bg); color:var(--qty-ink);
    border-radius:12px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);
  }
  html[data-theme="light"] .qtywrap{ background:#f3f4f6; color:#111; }
  .icon-btn{
    width:24px; height:24px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center;
    font-weight:800; cursor:pointer; user-select:none; background:transparent; border:none;
  }
  .icon-btn.red{background:#ef4444; color:#fff}
  .icon-btn.green{background:#22c55e; color:#fff}
  html[data-theme="light"] .icon-btn{ color:#111; }

  .qty{
    width:64px; padding:6px 8px; border-radius:8px; border:0; outline:none;
    background:transparent; color:var(--qty-ink); text-align:center; font-weight:700;
    -moz-appearance:textfield;
  }
  html[data-theme="light"] .qty{ color:#111; }
  .qty::-webkit-outer-spin-button,.qty::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }

  .sum{font-weight:800}
  .overdot{width:10px;height:10px;border-radius:50%;background:var(--over);display:inline-block}
  .overwrap{display:flex;align-items:center;gap:6px}

  .more a{
    display:inline-block; padding:8px 14px; border-radius:12px; text-decoration:none;
    background:var(--chip-bg); color:var(--chip-ink); font-weight:600
  }

  @media(min-width:760px){.list{grid-template-columns:repeat(2,1fr)} .card{padding:14px}}
  @media(min-width:1100px){.list{grid-template-columns:repeat(3,1fr)}}

  /* Detail */
  .detail{padding:12px}
  .detail .topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .back{border:1px solid var(--border);background:var(--input);color:var(--inputText);border-radius:8px;padding:8px 10px;cursor:pointer;display:inline-flex;gap:6px;align-items:center}
  .detail .head{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px;display:grid;gap:10px;box-shadow:var(--shadow)}
  .detail .head.oos{opacity:.65;filter:grayscale(100%)}
  .detail .hrow{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .detail .title1{font-weight:800}
  .detail .hero{display:flex;gap:14px;align-items:center}
  .detail .hero img{width:120px;height:120px;object-fit:contain;background:#fff;border:1px solid var(--border);border-radius:10px;cursor:pointer}

  .tabs{margin-top:12px;display:flex;gap:6px;flex-wrap:wrap}
  .tabbtn{padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:var(--input);color:var(--inputText);cursor:pointer;font-size:13px}
  .tabbtn.active{background:#111;color:#fff;border-color:#111}
  html[data-theme="dark"] .tabbtn.active{background:#fff;color:#111;border-color:#fff}
  .tabpanel{margin-top:10px;background:var(--input);color:var(--inputText);border:1px solid var(--border);border-radius:12px;padding:12px}
  .block{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:10px}
  html[data-theme="dark"] .block{background:#2c2c2e}
  .block pre{white-space:pre-wrap;margin:0;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:13px;line-height:1.4}

  .footer{padding:14px;text-align:center;color:var(--muted);font-size:12px}

  /* Lightbox */
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:1200}
  .lightbox img{max-width:92vw;max-height:90vh;background:#fff;border-radius:10px;padding:6px}

  /* Drawer (cart) */
  .drawer{
    position:fixed; top:0; right:0; width:460px; max-width:94vw; height:100vh; background:var(--bg);
    border-left:1px solid var(--border); box-shadow:-4px 0 16px rgba(0,0,0,.25);
    transform:translateX(100%); transition:.25s; z-index:1100; display:flex; flex-direction:column
  }
  .drawer.open{transform:translateX(0)}
  .drawer header{
    position:sticky; top:0; z-index:2;
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:10px; border-bottom:1px solid var(--border); background:var(--bg);
    min-height:var(--drawer-head);
    color:var(--ink);
  }
  .drawer .meta-top{font-size:15px; font-weight:800; display:flex; align-items:center; gap:8px; color:var(--ink);}
  #drawerTotal{ color:var(--ink) !important; }
  .drawer .body{padding:10px; padding-top:80px; overflow:auto; display:flex; flex-direction:column; gap:8px; -webkit-overflow-scrolling:touch}
  .line{border:1px solid var(--border);border-radius:10px;padding:10px;background:var(--card)}
  .line-top{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .line-qty{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

  /* Header icon colors (inline SVGs use currentColor automatically) */
  /* Download button contrast (dark) */
  html[data-theme="dark"] #btnDownload{
    background:#3a3a3c; border-color:#3a3a3c; color:#f2f2f7;
  }

  /* Lightbulb image tint */
  #themeIcon { width:22px;height:22px; }
  html[data-theme="light"] #themeIcon{ filter:var(--bulb-warm-filter); }
  html[data-theme="dark"]  #themeIcon{ filter:var(--bulb-cool-filter); }
</style>
</head>
<body>
  <!-- Header -->
  <header id="hdr">
    <img class="logo" src="logo.png" alt="E" onerror="this.style.display='none'">
    <div class="hdr-spacer"></div>

    <div class="chip" id="grandTotal">0 ₸</div>

    <button id="themeToggle" class="hdr-btn" title="Тема" aria-label="Переключить тему">
      <!-- we swap the src between bulb-on and crossed-bulb-off -->
      <img id="themeIcon" alt="theme">
    </button>

    <button id="openCart" class="hdr-btn" title="Корзина" aria-label="Открыть корзину">
      <!-- Cart (inline SVG, currentColor, clean lines) -->
      <svg id="cartIcon" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="8" cy="21" r="1"></circle>
        <circle cx="19" cy="21" r="1"></circle>
        <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path>
      </svg>
      <span id="cartBadge" style="margin-left:6px;font-weight:800;color:inherit;font-size:14px">0</span>
    </button>
  </header>

  <!-- Controls -->
  <div class="controls" id="controls">
    <div class="group">
      <div class="search">
        <input id="q" type="text" placeholder="Артикул или модель…" autocomplete="off" />
        <button class="clear-btn" id="clear" title="Очистить" aria-label="Очистить">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 6 6 18"></path><path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <label class="group" style="font-size:13px">
        <input type="checkbox" id="onlyInStock" />
        <span>Только в наличии</span>
      </label>

      <label class="group" style="font-size:13px">
        <input type="checkbox" id="showImages" />
        <span>Изображения</span>
      </label>

      <div class="group" title="Сортировка">
        <select id="sortKey">
          <option value="default">Сортировка</option>
          <option value="price_desc">Цена ↓</option>
          <option value="price_asc">Цена ↑</option>
          <option value="stock_desc">Остаток ↓</option>
          <option value="stock_asc">Остаток ↑</option>
        </select>
      </div>

      <div class="group" title="Выгрузка">
        <select id="downloadFmt">
          <option value="xlsx">Excel</option>
          <option value="csv">CSV</option>
          <option value="json">JSON</option>
          <option value="xml">XML</option>
        </select>
        <button class="btn" id="btnDownload" title="Скачать">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 8v8"></path><path d="m8 12 4 4 4-4"></path>
          </svg>
          <span>Скачать</span>
        </button>
      </div>
    </div>
  </div>

  <!-- List view -->
  <div id="view-list">
    <div class="stats" id="stats">Загрузка…</div>
    <div class="muted" id="error" hidden></div>
    <div class="list" id="list"></div>
  </div>

  <!-- Detail view -->
  <div id="view-detail" class="detail hidden">
    <div class="topbar">
      <button class="back" id="btnBack" title="Назад">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M18 6 6 18"></path><path d="M6 6l12 12"></path>
        </svg>
        <span>Назад</span>
      </button>
    </div>
    <div id="detail-head" class="head"></div>
    <div class="tabs" id="tabs"></div>
    <div class="tabpanel" id="tabpanel"></div>
  </div>

  <div class="footer" id="footer"></div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" onclick="this.style.display='none'">
    <img id="lightboxImg" alt="preview">
  </div>

  <!-- Cart drawer -->
  <aside class="drawer" id="drawer" aria-hidden="true">
    <header id="drawerHeader">
      <div class="meta-top">Итого: <span id="drawerTotal">0 ₸</span></div>
      <div class="meta-top" style="gap:6px;font-weight:600">
        <button class="btn" id="drawerClear" title="Очистить">
          <!-- Trash (always red) -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
            <path d="M3 6h18"></path>
            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        </button>
        <button class="btn" id="exportCart" title="Excel">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 8v8"></path><path d="m8 12 4 4 4-4"></path>
          </svg>
        </button>
        <button class="btn" id="closeCart" title="Закрыть">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 6 6 18"></path><path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </header>
    <div class="body" id="drawerBody"></div>
  </aside>

<script>
  /* ---- Bulb icons (your data URIs) ---- */
  const BULB_ON = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWxpZ2h0YnVsYi1pY29uIGx1Y2lkZS1saWdodGJ1bGIiPjxwYXRoIGQ9Ik0xNSAxNGMuMi0xIC43LTEuNyAxLjUtMi41IDEtLjkgMS41LTIuMiAxLjUtMy41QTYgNiAwIDAgMCA2IDhjMCAxIC4yIDIuMiAxLjUgMy41LjcuNyAxLjMgMS41IDEuNSAyLjUiLz48cGF0aCBkPSJNOSAxOGg2Ii8+PHBhdGggZD0iTTEwIDIyaDQiLz48L3N2Zz4=";
  const BULB_OFF_X = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWxpZ2h0YnVsYi1vZmYtaWNvbiBsdWNpZGUtbGlnaHRidWxiLW9mZiI+PHBhdGggZD0iTTE2LjggMTEuMmMuOC0uOSAxLjItMiAxLjItMy4yYTYgNiAwIDAgMC05LjMtNSIvPjxwYXRoIGQ9Im0yIDIgMjAgMjAiLz48cGF0aCBkPSJNNi4zIDYuM2E0LjY3IDQuNjcgMCAwIDAgMS4yIDUuMmMuNy43IDEuMyAxLjUgMS41IDIuNSIvPjxwYXRoIGQ9Ik05IDE4aDYiLz48cGF0aCBkPSJNMTAgMjJoNCIvPjwvc3ZnPg==";

  /* ---- Small inline-SVG helpers for dynamic rows ---- */
  const SVGs = {
    tick: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg>`,
    cancel: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><path d="M15 9 9 15"></path><path d="M9 9l6 6"></path></svg>`
  };

  /* ---- Config ---- */
  const XML_URL = "https://einhellcentralasia.github.io/kaspi_stock/price.xml";
  const IMAGES_CSV_URL = "./images.csv";
  const DETAILS_CSV_URL = "./add_data.csv";

  /* ---- Helpers ---- */
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const fmt = n => isNaN(n)?n:new Intl.NumberFormat("ru-KZ",{maximumFractionDigits:0}).format(+n)+" ₸";
  const debounce=(fn,ms=220)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
  const getByLocalName=(node,local)=>Array.from(node.getElementsByTagNameNS("*",local));
  const firstByLocalName=(node,local)=>{const a=getByLocalName(node,local);return a.length?a[0]:null};
  const escCSV=v=>{const s=String(v??"");return /[",;\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s};
  function downloadBlob(filename, mime, data){ const blob=new Blob([data],{type:mime}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove(); }

  /* ---- DOM ---- */
  const hdr=$("#hdr"), controls=$("#controls");
  const viewList=$("#view-list"), viewDetail=$("#view-detail");
  const q=$("#q"), clearBtn=$("#clear"), onlyInStock=$("#onlyInStock"), showImages=$("#showImages");
  const sortKey=$("#sortKey"), downloadFmt=$("#downloadFmt"), btnDownload=$("#btnDownload");
  const list=$("#list"), stats=$("#stats"), errorBox=$("#error");
  const lightbox=$("#lightbox"), lightboxImg=$("#lightboxImg");
  const btnBack=$("#btnBack"), detailHead=$("#detail-head"), tabsEl=$("#tabs"), tabpanel=$("#tabpanel");
  const openCart=$("#openCart"), closeCart=$("#closeCart"), drawer=$("#drawer"), drawerBody=$("#drawerBody"), drawerHeader=$("#drawerHeader");
  const drawerTotal=$("#drawerTotal");
  const cartBadge=$("#cartBadge"), grandTotal=$("#grandTotal");
  const themeToggle=$("#themeToggle"), themeIcon=$("#themeIcon");

  /* ---- State ---- */
  let OFFERS=[], IMG_MAP=new Map(), DETAIL_MAP=new Map();
  const CART=new Map(); const CART_KEY="einhell_cart_v1";

  /* ---- Theme ---- */
  function setBulbForTheme(){
    const cur=document.documentElement.getAttribute('data-theme')||'light';
    if(cur==='light'){ themeIcon.src=BULB_ON;  }
    else { themeIcon.src=BULB_OFF_X; }
  }
  const applyTheme=t=>{
    document.documentElement.setAttribute('data-theme',t);
    setBulbForTheme();
  };
  themeToggle.addEventListener('click', ()=>{
    const cur=document.documentElement.getAttribute('data-theme')||'light';
    const next=cur==='light'?'dark':'light';
    applyTheme(next); localStorage.setItem('theme', next);
    updateOffsets();
  });
  applyTheme(localStorage.getItem('theme')||'light');

  /* ---- Layout offsets ---- */
  function updateOffsets(){
    const h = hdr.offsetHeight || 56;
    document.documentElement.style.setProperty('--hdr-h', h + "px");
    document.documentElement.style.setProperty('--controls-top', h + "px");
    const dh = drawerHeader?.offsetHeight || 52;
    document.documentElement.style.setProperty('--drawer-head', dh + "px");
  }
  window.addEventListener('resize', updateOffsets);

  /* ---- Fetchers ---- */
  async function fetchText(url){ const res=await fetch(url+"?t="+Date.now(),{cache:"no-store"}); if(!res.ok) throw new Error("HTTP "+res.status+" for "+url); return res.text(); }
  async function fetchXML(){ const txt=await fetchText(XML_URL); const xml=new DOMParser().parseFromString(txt,"application/xml"); if(xml.querySelector("parsererror")) throw new Error("XML parse error"); return xml; }
  async function fetchImages(){ try{ const csv=await fetchText(IMAGES_CSV_URL); const p=Papa.parse(csv,{header:true,skipEmptyLines:true}); IMG_MAP.clear(); (p.data||[]).forEach(r=>{const s=(r.sku||"").trim(), u=(r.url||"").trim(); if(s&&u&&u!=="-") IMG_MAP.set(s,u);}); }catch(e){ IMG_MAP.clear();}}
  async function fetchDetails(){ try{ const csv=await fetchText(DETAILS_CSV_URL); const p=Papa.parse(csv,{header:true,skipEmptyLines:false}); DETAIL_MAP.clear(); (p.data||[]).forEach(r=>{const s=(r.sku||"").trim(); if(!s) return; DETAIL_MAP.set(s,{tech:(r.tech||"").trim(),log:(r.log||"").trim(),marketing:(r.marketing||"").trim(),add:(r.add||"").trim()});}); }catch(e){ DETAIL_MAP.clear();}}

  function parseOffers(xml){
    return getByLocalName(xml,"offer").map(offer=>{
      const sku=offer.getAttribute("sku")||"";
      const model=(firstByLocalName(offer,"model")?.textContent||"").trim();
      const modelLC=model.toLowerCase();
      const av=firstByLocalName(offer,"availability");
      const available=(av?.getAttribute("available")||"no").toLowerCase()==="yes";
      const stock=Number(av?.getAttribute("stockCount")||"0");
      const price=Number((firstByLocalName(offer,"price")?.textContent||"0").replace(/[^\d]/g,""));
      return {sku,model,modelLC,available,stock,price};
    });
  }

  /* Sorting/filtering */
  function sortOffers(arr){
    switch (sortKey.value){
      case "price_desc": return arr.slice().sort((a,b)=> b.price - a.price);
      case "price_asc":  return arr.slice().sort((a,b)=> a.price - b.price);
      case "stock_desc": return arr.slice().sort((a,b)=> b.stock - a.stock);
      case "stock_asc":  return arr.slice().sort((a,b)=> a.stock - b.stock);
      default:           return arr.slice().sort((a,b)=>(b.available-a.available)||(b.stock-a.stock)||a.model.localeCompare(b.model));
    }
  }
  function currentFiltered(){
    const term=q.value.trim().toLowerCase();
    return OFFERS.filter(o=>{
      const hit=o.sku.toLowerCase().includes(term)||o.modelLC.includes(term);
      return hit && (!onlyInStock.checked || o.stock>0);
    });
  }

  /* ---- Cart (persist) ---- */
  function saveCart(){ const arr=[]; CART.forEach((v,sku)=>arr.push([sku,v.qty,v.price,v.model])); localStorage.setItem(CART_KEY, JSON.stringify(arr.slice(0,100))); }
  function loadCart(){ try{ const raw=localStorage.getItem(CART_KEY); if(!raw) return; const arr=JSON.parse(raw); CART.clear(); for(const [sku,qty,price,model] of arr){ if(sku && qty>0) CART.set(sku,{qty:+qty,price:+price,model}); } }catch{} }
  function cartSet(sku, qty, price, model){ if(qty<=0){ CART.delete(sku); } else { CART.set(sku,{qty:+qty, price:+price, model}); } updateCartUI(); saveCart(); }
  function cartClear(){ CART.clear(); updateCartUI(); saveCart(); }
  function cartTotals(){ let lines=0,total=0; CART.forEach(v=>{lines+=1; total+=v.qty*v.price;}); return {lines,total}; }
  function updateCartUI(){
    const {lines,total}=cartTotals();
    cartBadge.textContent=lines;
    grandTotal.textContent=fmt(total);
    drawerTotal.textContent=fmt(total);
    renderDrawer();

    // refresh per-card UI
    $$(".card").forEach(card=>{
      const sku=card.getAttribute("data-sku"); const v=CART.get(sku);
      const sumEl=$(".sum",card); const qtyIn=$(".qty",card);
      const stock=+card.getAttribute("data-stock"); const overWrap=$(".overwrap",card);
      if(v && v.qty>0){
        sumEl.textContent=fmt(v.qty*(+card.getAttribute("data-price"))); sumEl.classList.remove("hidden");
        if(!qtyIn.matches(":focus")) qtyIn.value=v.qty;
        overWrap.classList.toggle("hidden", !(v.qty>stock)); overWrap.title=`Склад: ${stock}`;
      }else{
        sumEl.classList.add("hidden");
        if(!qtyIn.matches(":focus")) qtyIn.value="";
        overWrap.classList.add("hidden");
      }
    });
  }
  function renderDrawer(){
    const body=drawerBody; body.innerHTML="";
    if(CART.size===0){ body.innerHTML=`<div class="muted">Корзина пуста</div>`; return; }
    CART.forEach((v,sku)=>{
      const o=OFFERS.find(x=>x.sku===sku); const stock=o?o.stock:0, img=IMG_MAP.get(sku)||"";
      const line=document.createElement("div"); line.className="line";
      line.innerHTML=`
        <div class="line-top">
          <div><b>${sku}</b> • ${o?o.model:v.model}</div>
          <div>${fmt(v.price)}</div>
        </div>
        <div class="line-qty">
          ${img?`<img src="${img}" style="width:40px;height:40px;object-fit:contain;border:1px solid var(--border);border-radius:8px;background:#fff">`:``}
          <div class="qtywrap">
            <button class="icon-btn red" data-clear="${sku}" title="Удалить" aria-label="Удалить">
              ${SVGs.cancel}
            </button>
            <input type="text" inputmode="numeric" pattern="[0-9]*" class="qty" value="${v.qty}" data-sku="${sku}">
            <button class="icon-btn green" data-apply="${sku}" title="Применить" aria-label="Применить">
              ${SVGs.tick}
            </button>
          </div>
          <span class="sum">${fmt(v.qty*v.price)}</span>
          <span class="overwrap ${v.qty>stock?"":"hidden"}" title="Склад: ${stock}"><span class="overdot"></span></span>
        </div>`;
      body.appendChild(line);
    });
  }

  /* ---- Render list & details ---- */
  function renderList(){
    viewList.classList.remove("hidden"); viewDetail.classList.add("hidden");
    const data=sortOffers(currentFiltered());
    list.innerHTML="";
    if(!data.length){
      list.innerHTML=`<div class="card"><div class="model">Ничего не найдено.</div></div>`;
      stats.textContent="—";
      return;
    }
    const imgsOn=showImages.checked;
    const frag=document.createDocumentFragment();
    for(const o of data){
      const card=document.createElement("div");
      card.className="card";
      card.setAttribute("data-sku",o.sku);
      card.setAttribute("data-price",o.price);
      card.setAttribute("data-stock",o.stock);
      if(o.stock===0) card.classList.add("oos");

      const badgeClass=o.stock>0?"ok":"no";
      const badgeText=o.stock>0?"В наличии":"Нет в наличии";
      const imgUrl=IMG_MAP.get(o.sku)||"";
      const hasDetails=DETAIL_MAP.has(o.sku);
      const v=CART.get(o.sku);

      card.innerHTML=`
        <div class="row1">
          <div class="sku">${o.sku}</div>
          <span class="badge ${badgeClass}">${badgeText}</span>
        </div>

        <div class="model">${o.model}</div>

        <div class="meta">
          <div class="leftMeta">
            ${imgUrl && imgsOn ? `<img class="thumb" loading="lazy" src="${imgUrl}" alt="${o.model}">` : ``}
            <div class="stock">Кол-во: ${o.stock}</div>
          </div>
          <div class="price">${fmt(o.price)}</div>
        </div>

        <div class="actions">
          <div class="ctrls">
            <div class="qtywrap">
              <button class="icon-btn red" title="Очистить" aria-label="Очистить">${SVGs.cancel}</button>
              <input type="text" inputmode="numeric" pattern="[0-9]*" class="qty" placeholder="шт." value="${v?v.qty:""}">
              <button class="icon-btn green" title="Добавить" aria-label="Добавить">${SVGs.tick}</button>
            </div>
            <span class="overwrap ${v&&v.qty>o.stock?"":"hidden"}" title="Склад: ${o.stock}"><span class="overdot"></span></span>
          </div>
          <div class="sum ${v&&v.qty>0?"":"hidden"}">${v?fmt(v.qty*o.price):""}</div>
        </div>

        <div class="more">
          ${hasDetails ? `<a href="#sku=${encodeURIComponent(o.sku)}">Подробнее</a>` : `<span class="muted">Нет доп. данных</span>`}
        </div>
      `;

      if(imgUrl && imgsOn){ $(".thumb",card)?.addEventListener("click", ()=>{ $("#lightboxImg").src=imgUrl; $("#lightbox").style.display='flex'; }); }

      const qtyInput=$(".qty",card);
      const btnClear=$(".icon-btn.red",card);
      const btnApply=$(".icon-btn.green",card);

      qtyInput.addEventListener("input", ()=>{ qtyInput.value = qtyInput.value.replace(/\D+/g,"").slice(0,6); });

      btnApply.addEventListener("click", ()=>{
        const qStr=qtyInput.value.trim(); const qty = qStr==="" ? 0 : Math.max(0, parseInt(qStr,10));
        cartSet(o.sku, qty, o.price, o.model);
      });
      btnClear.addEventListener("click", ()=>{ cartSet(o.sku, 0, o.price, o.model); });

      frag.appendChild(card);
    }
    list.appendChild(frag);

    // shown / total / selected
    const selected = CART.size;
    stats.textContent = `Показано ${data.length} / ${OFFERS.length}${onlyInStock.checked?" (только в наличии)":""}${showImages.checked?"":" • изображения скрыты"} • выбрано: ${selected}`;
    updateCartUI();
  }

  function renderDetail(sku, tab="details"){
    viewList.classList.add("hidden"); viewDetail.classList.remove("hidden");
    const o=OFFERS.find(x=>x.sku===sku);
    const d=DETAIL_MAP.get(sku)||{tech:"",log:"",marketing:"",add:""};
    const imgUrl=IMG_MAP.get(sku)||"";
    detailHead.className="head"+((o&&o.stock===0)?" oos":"");
    const badge=o?(o.stock>0?`<span class="badge ok">В наличии</span>`:`<span class="badge no">Нет в наличии</span>`):"";
    detailHead.innerHTML=`
      <div class="hrow"><div class="title1">${o?o.sku:sku}</div>${badge}</div>
      <div class="hrow"><div>${o?o.model:""}</div><div class="price">${o?fmt(o.price):""}</div></div>
      <div class="hero">${imgUrl?`<img id="heroImg" loading="lazy" src="${imgUrl}" alt="${o?o.model:""}">`:""}${o?`<div class="muted">Остаток: ${o.stock}</div>`:""}</div>`;
    $("#heroImg")?.addEventListener("click", ()=>{ $("#lightboxImg").src=imgUrl; $("#lightbox").style.display='flex'; });

    const tabs=[{id:"details",label:"Подробнее"},{id:"tech",label:"Тех"},{id:"log",label:"Лог"},{id:"marketing",label:"Маркетинг"}];
    tabsEl.innerHTML="";
    tabs.forEach(t=>{
      const b=document.createElement("button");
      b.className="tabbtn"+(t.id===tab?" active":"");
      b.textContent=t.label;
      b.addEventListener("click", ()=>{
        const base = `#sku=${encodeURIComponent(sku)}`;
        location.replace(t.id==="details" ? base : `${base}&tab=${t.id}`);
      });
      tabsEl.appendChild(b);
    });

    let html="";
    if (tab==="details" && d.add) html += `<div class="block"><pre>${d.add}</pre></div>`;
    if (tab==="tech" && d.tech) html += `<div class="block"><pre>${d.tech}</pre></div>`;
    if (tab==="log" && d.log) html += `<div class="block"><pre>${d.log}</pre></div>`;
    if (tab==="marketing" && d.marketing) html += `<div class="block"><pre>${d.marketing}</pre></div>`;
    if (!html) html = `<div class="muted">Нет доп. данных</div>`;
    tabpanel.innerHTML = html;
  }

  /* ---- Exports ---- */
  function exportExcel(rows){
    const out = rows.map(o=>{
      const d = DETAIL_MAP.get(o.sku) || {};
      return { Артикул:o.sku, Модель:o.model, Остаток:o.stock, Цена:o.price,
        Изображение: IMG_MAP.get(o.sku)||"", Тех:d.tech||"", Лог:d.log||"", Маркетинг:d.marketing||"", Подробнее:d.add||"" };
    });
    const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(out);
    ws["!cols"]=[{wch:12},{wch:50},{wch:10},{wch:12},{wch:40},{wch:40},{wch:40},{wch:40},{wch:40}];
    XLSX.utils.book_append_sheet(wb, ws, "Прайс"); XLSX.writeFile(wb, "einhell_price.xlsx");
  }
  function exportCSV(rows){
    const header=["Артикул","Модель","Остаток","Цена","Изображение","Тех","Лог","Маркетинг","Подробнее"];
    const lines=[header.map(escCSV).join(",")];
    for(const o of rows){
      const d=DETAIL_MAP.get(o.sku)||{};
      lines.push([o.sku,o.model,o.stock,o.price,IMG_MAP.get(o.sku)||"",d.tech||"",d.log||"",d.marketing||"",d.add||""].map(escCSV).join(","));
    }
    downloadBlob("einhell_price.csv","text/csv;charset=utf-8",lines.join("\n"));
  }
  function exportJSON(rows){
    const arr=rows.map(o=>{ const d=DETAIL_MAP.get(o.sku)||{}; return {sku:o.sku,model:o.model,stock:o.stock,price:o.price,image:IMG_MAP.get(o.sku)||null,tech:d.tech||"",log:d.log||"",marketing:d.marketing||"",details:d.add||""};});
    downloadBlob("einhell_price.json","application/json;charset=utf-8",JSON.stringify(arr,null,2));
  }
  function exportXML(rows){
    const esc=s=>String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    let xml=`<?xml version="1.0" encoding="UTF-8"?><items>`;
    for(const o of rows){
      const d=DETAIL_MAP.get(o.sku)||{}, img=IMG_MAP.get(o.sku)||"";
      xml+=`<item sku="${esc(o.sku)}"><model>${esc(o.model)}</model><stock>${o.stock}</stock><price>${o.price}</price>${img?`<image>${esc(img)}</image>`:""}<tech>${esc(d.tech||"")}</tech><log>${esc(d.log||"")}</log><marketing>${esc(d.marketing||"")}</marketing><details>${esc(d.add||"")}</details></item>`;
    }
    xml+=`</items>`; downloadBlob("einhell_price.xml","application/xml;charset=utf-8",xml);
  }

  /* ---- Router ---- */
  function parseHash(){ const h=location.hash.replace(/^#/,""); if(h.includes("sku=")){ const sp=new URLSearchParams(h); return {sku:sp.get("sku"), tab:(sp.get("tab")||"details")}; } return {sku:null,tab:null};}
  function renderRoute(){ const {sku,tab}=parseHash(); if(sku){ renderDetail(sku,tab||"details"); } else { renderList(); } }

  /* ---- Init & events ---- */
  async function init(){
    try{
      updateOffsets();
      stats.textContent="Загрузка…";
      loadCart();
      await Promise.all([fetchImages(), fetchDetails()]);
      const xml=await fetchXML(); OFFERS=parseOffers(xml);
      if(OFFERS.length===0) throw new Error("Parsed 0 offers");
      $("#footer").textContent="Обновлено: " + new Date().toLocaleString();
      errorBox.hidden=true;
      renderRoute();
    }catch(err){
      console.error(err);
      errorBox.hidden=false; errorBox.textContent="Не удалось загрузить: " + err.message; stats.textContent="—";
    }
  }

  q.addEventListener("input",debounce(()=>{ if(!location.hash) renderList(); },220));
  onlyInStock.addEventListener("change",()=>{ if(!location.hash) renderList(); });
  showImages.addEventListener("change",()=>{ if(!location.hash) renderList(); });
  sortKey.addEventListener("change",()=>{ if(!location.hash) renderList(); });
  clearBtn.addEventListener("click",()=>{ q.value=""; if(!location.hash){ renderList(); q.focus(); } });

  btnBack.addEventListener("click", ()=>{ location.replace("#"); renderList(); });

  btnDownload.addEventListener("click", ()=>{
    const rows=sortOffers(currentFiltered());
    switch(downloadFmt.value){
      case "xlsx": return exportExcel(rows);
      case "csv":  return exportCSV(rows);
      case "json": return exportJSON(rows);
      case "xml":  return exportXML(rows);
    }
  });

  // Drawer open/close – lock background scroll while open
  $("#openCart").addEventListener("click", ()=>{
    drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false");
    document.body.classList.add("no-scroll");
    updateOffsets();
  });
  $("#closeCart").addEventListener("click", ()=>{
    drawer.classList.remove("open"); drawer.setAttribute("aria-hidden","true");
    document.body.classList.remove("no-scroll");
  });

  // Drawer interactions
  $("#drawerClear").addEventListener("click", ()=> cartClear());
  $("#exportCart").addEventListener("click", ()=>{
    if(CART.size===0) return;
    const rows=[];
    CART.forEach((v,sku)=>{
      const o=OFFERS.find(x=>x.sku===sku);
      rows.push({ SKU:sku, Model:o?o.model:v.model, Price:v.price, Qty:v.qty, Sum:v.qty*v.price });
    });
    const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(rows);
    ws["!cols"]=[{wch:12},{wch:50},{wch:12},{wch:8},{wch:14}];
    XLSX.utils.book_append_sheet(wb, ws, "Cart");
    const def=`order_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.xlsx`;
    const name=prompt("Имя файла:", def) || def;
    XLSX.writeFile(wb, name);
  });

  drawerBody.addEventListener("input", (e)=>{
    if(e.target.classList.contains("qty")){
      e.target.value = e.target.value.replace(/\D+/g,"").slice(0,6);
    }
  });
  drawerBody.addEventListener("click", (e)=>{
    const clr = e.target.closest("[data-clear]")?.getAttribute("data-clear");
    const apply = e.target.closest("[data-apply]")?.getAttribute("data-apply");
    if (clr){ CART.delete(clr); updateCartUI(); saveCart(); }
    if (apply){
      const input = drawerBody.querySelector(`.qty[data-sku="${apply}"]`);
      const v=CART.get(apply); if(!v||!input) return;
      const qval = input.value ? parseInt(input.value,10) : 0;
      cartSet(apply, qval, v.price, v.model);
    }
  });

  window.addEventListener("hashchange", renderRoute);
  setInterval(init,30*60*1000);
  init();
</script>
</body>
</html>
